<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Starezo Module App</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{font-family:sans-serif;margin:20px;}
button{padding:8px 12px;margin:5px;}
</style>
</head>

<body>

<h2>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²</h2>

<input type="file" id="imageInput" accept="image/*" style="display:none">

<button onclick="document.getElementById('imageInput').click()">
ğŸ“· ã‚¹ã‚¯ã‚·ãƒ§ã‹ã‚‰è‡ªå‹•ç™»éŒ²
</button>

<div id="moduleList"></div>

<script>

// ===== æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ =====
let modules = JSON.parse(localStorage.getItem("modules")||"[]");

const linkTypes = [
"æ¥µé©å¿œåŠ›","ç­‹åŠ›å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","HPå¢—å¼·",
"æ”»æ’ƒå¼·åŒ–","ä¼šå¿ƒå¼·åŒ–","æ”»æ’ƒé€Ÿåº¦","è© å”±é€Ÿåº¦","å›å¾©å¼·åŒ–",
"è€æ€§å¢—å¼·","å¸åå¼·åŒ–","å¹¸é‹å¼·åŒ–","æ‰“æ’ƒå¼·åŒ–","ç²¾é‹­å¼·åŒ–",
"é›†ä¸­å¼·åŒ–","é˜²å¾¡å¼·åŒ–","å±æ€§å¼·åŒ–","HPå¸å","MPå¸å",
"æ¥µé›†ä¸­åŠ›"
];

// ===== ä¿å­˜ç³» =====
function save(){
localStorage.setItem("modules",JSON.stringify(modules));
}

function render(){
const list=document.getElementById("moduleList");
list.innerHTML="";
modules.forEach((m,i)=>{
const div=document.createElement("div");
div.textContent=JSON.stringify(m.links);
list.appendChild(div);
});
}

function makeKey(links){
return links
.slice()
.sort((a,b)=>a.name.localeCompare(b.name))
.map(l=>l.name+":"+l.value)
.join("|");
}

render();

// ===== OCRç™»éŒ² =====
document.getElementById("imageInput").addEventListener("change",e=>{
if(e.target.files[0]) readFromImage(e.target.files[0]);
});

async function readFromImage(file){

const img=new Image();
img.src=URL.createObjectURL(file);
await img.decode();

const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");
canvas.width=img.width;
canvas.height=img.height;
ctx.drawImage(img,0,0);

// å³ãƒ‘ãƒãƒ«æ¤œå‡º
const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
let columnBrightness=[];
for(let x=0;x<canvas.width;x++){
let sum=0;
for(let y=0;y<canvas.height;y+=20){
let i=(y*canvas.width+x)*4;
sum+=data[i]+data[i+1]+data[i+2];
}
columnBrightness.push(sum);
}
let split=columnBrightness.findIndex(v=>v<columnBrightness[0]*0.7);
if(split<0) split=Math.floor(canvas.width*0.55);

const panelWidth=canvas.width-split;
const panelHeight=canvas.height*0.6;
const panelY=canvas.height*0.2;

const panelCanvas=document.createElement("canvas");
const pctx=panelCanvas.getContext("2d");
panelCanvas.width=panelWidth;
panelCanvas.height=panelHeight;

pctx.drawImage(canvas,split,panelY,panelWidth,panelHeight,0,0,panelWidth,panelHeight);

// 3è¡Œåˆ†å‰²
const rowHeight=panelHeight/3;
let links=[];

for(let r=0;r<3;r++){

const rowCanvas=document.createElement("canvas");
const rctx=rowCanvas.getContext("2d");
rowCanvas.width=panelWidth;
rowCanvas.height=rowHeight;

rctx.drawImage(panelCanvas,0,r*rowHeight,panelWidth,rowHeight,0,0,panelWidth,rowHeight);

// ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆ
const rowData=rctx.getImageData(0,0,rowCanvas.width,rowCanvas.height).data;
let barCount=0;
let inBar=false;

for(let x=0;x<rowCanvas.width;x++){
let bluePixels=0;
for(let y=0;y<rowCanvas.height;y+=5){
let i=(y*rowCanvas.width+x)*4;
let rC=rowData[i];
let gC=rowData[i+1];
let bC=rowData[i+2];
if(bC>150&&gC>120&&rC<120) bluePixels++;
}
if(bluePixels>5){
if(!inBar){barCount++;inBar=true;}
}else inBar=false;
}

// ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸ
const textCanvas=document.createElement("canvas");
const tctx=textCanvas.getContext("2d");
textCanvas.width=rowCanvas.width*0.6;
textCanvas.height=rowCanvas.height;
tctx.drawImage(rowCanvas,0,0,textCanvas.width,rowCanvas.height,0,0,textCanvas.width,rowCanvas.height);

// äºŒå€¤åŒ–
const imgData=tctx.getImageData(0,0,textCanvas.width,textCanvas.height);
const d=imgData.data;
for(let i=0;i<d.length;i+=4){
const gray=0.3*d[i]+0.59*d[i+1]+0.11*d[i+2];
const v=gray>150?255:0;
d[i]=d[i+1]=d[i+2]=v;
}
tctx.putImageData(imgData,0,0);

// OCR
const result=await Tesseract.recognize(textCanvas,'jpn',{
tessedit_pageseg_mode:7
});

let raw=result.data.text.replace(/[ãƒ»\s]/g,"");

// è¾æ›¸ãƒãƒƒãƒ
function similarity(a,b){
let match=0;
for(let i=0;i<Math.min(a.length,b.length);i++){
if(a[i]===b[i]) match++;
}
return match/Math.max(a.length,b.length);
}

let best=null;
let bestScore=0;

linkTypes.forEach(type=>{
const score=similarity(raw,type);
if(score>bestScore){
bestScore=score;
best=type;
}
});

if(best && bestScore>0.6 && barCount>0){
links.push({name:best,value:barCount});
}

}

if(links.length===0){
alert("èª­ã¿å–ã‚Šå¤±æ•—");
return;
}

// é‡è¤‡ç¢ºèª
const key=makeKey(links);
const exists=modules.some(m=>makeKey(m.links)===key);

if(exists){
if(!confirm("åŒã˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ"))
return;
}

modules.push({links});
save();
render();

alert("ç™»éŒ²å®Œäº†");

}

</script>
</body>
</html>
